<!DOCTYPE html>
<html>
<head>
    <title>Test Role Validation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .valid { border-color: green; background: #f0fff0; }
        .invalid { border-color: red; background: #fff0f0; }
        .info { background: #f0f8ff; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Testing Role Validation</h1>
    <button onclick="testRoles()">Test Roles</button>
    <div id="results"></div>

    <script>
        async function testRoles() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Starting role validation test...</h2>';
            
            // Check for token
            const token = localStorage.getItem('azure_jwt_token') || localStorage.getItem('token');
            if (!token) {
                results.innerHTML += '<p style="color: red;">‚ùå No token found. Please login as SuperAdmin first.</p>';
                results.innerHTML += '<p>Go to <a href="/superadmin/login">/superadmin/login</a> first, then come back here.</p>';
                return;
            }
            
            results.innerHTML += '<p style="color: green;">‚úÖ Token found, proceeding with tests...</p>';
            
            // First, get existing staff to see what roles are currently in use
            try {
                const staffResponse = await fetch('https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/superadmin/businesses/7/Users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (staffResponse.ok) {
                    const staffData = await staffResponse.json();
                    results.innerHTML += `<div class="info"><h3>üìã Current Staff (${staffData.length} members):</h3>`;
                    
                    const existingRoles = new Set();
                    staffData.forEach(staff => {
                        if (staff.role) {
                            existingRoles.add(staff.role);
                            results.innerHTML += `<p>‚Ä¢ ${staff.fullName || staff.email}: <strong>${staff.role}</strong></p>`;
                        }
                    });
                    
                    results.innerHTML += `<p><strong>Roles in database:</strong> ${Array.from(existingRoles).join(', ')}</p></div>`;
                } else {
                    results.innerHTML += `<p style="color: orange;">‚ö†Ô∏è Could not fetch existing staff: ${staffResponse.status}</p>`;
                }
            } catch (error) {
                results.innerHTML += `<p style="color: orange;">‚ö†Ô∏è Error fetching staff: ${error.message}</p>`;
            }
            
            // Test different roles
            const testRoles = ['Owner', 'Manager', 'Waiter', 'Bartender', 'Guest', 'Staff', 'Admin', 'Collector', 'Bar'];
            
            results.innerHTML += '<h2>üß™ Testing Role Validation:</h2>';
            
            for (const role of testRoles) {
                try {
                    const testUser = {
                        email: `test-${role.toLowerCase()}-${Date.now()}@test.local`,
                        password: '123456',
                        fullName: `Test ${role}`,
                        phoneNumber: `+355691${Math.floor(Math.random() * 1000000)}`,
                        role: role,
                        pin: '1234'
                    };
                    
                    const response = await fetch('https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/superadmin/businesses/7/Users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(testUser)
                    });

                    const isValid = response.status === 200 || response.status === 201;
                    const responseText = await response.text();
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch {
                        data = responseText;
                    }

                    const resultClass = isValid ? 'valid' : 'invalid';
                    const icon = isValid ? '‚úÖ' : '‚ùå';
                    
                    results.innerHTML += `
                        <div class="result ${resultClass}">
                            <h3>${icon} Role: "${role}"</h3>
                            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                            <p><strong>Valid:</strong> ${isValid ? 'YES' : 'NO'}</p>
                            ${!isValid ? `<p><strong>Error:</strong> ${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</p>` : ''}
                        </div>
                    `;

                    // Clean up test user if created successfully
                    if (isValid && data && data.id) {
                        try {
                            await fetch(`https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/superadmin/businesses/7/Users/${data.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            console.log(`‚úÖ Cleaned up test user for role: ${role}`);
                        } catch (cleanupError) {
                            console.log(`‚ö†Ô∏è Could not clean up test user for role: ${role}`);
                        }
                    }

                } catch (error) {
                    results.innerHTML += `
                        <div class="result invalid">
                            <h3>‚ùå Role: "${role}"</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                }

                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            results.innerHTML += '<div class="info"><h2>‚úÖ Role validation test completed!</h2><p>Check the results above to see which roles are valid.</p></div>';
        }
    </script>
</body>
</html>