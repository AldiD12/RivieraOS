<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        pre { background: #2a2a2a; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .status { font-weight: bold; margin: 10px 0; }
        input { padding: 8px; margin: 5px; background: #333; color: white; border: 1px solid #555; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîß Login Debug Test</h1>
    <p>Testing different login scenarios to identify the 401 issue...</p>

    <div class="test-section">
        <h3>Test Credentials</h3>
        <div>
            <label>Email: <input type="email" id="email" value="superadmin@rivieraos.com"></label><br>
            <label>Password: <input type="password" id="password" value="RivieraOS2024!"></label><br>
            <button onclick="testLogin()">Test SuperAdmin Login</button>
            <button onclick="testStaffLogin()">Test Staff Login (Marco)</button>
            <button onclick="testApiHealth()">Test API Health</button>
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
        </div>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h3>Request Details</h3>
        <div id="requestDetails"></div>
    </div>

    <script>
        async function runAllTests() {
            const result = document.getElementById('loginResult');
            result.innerHTML = '<div class="status">ÔøΩ Running comprehensive test suite...</div>';
            
            await testApiHealth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testStaffLogin();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLogin();
            
            result.innerHTML += '<div class="status success">‚úÖ All tests completed!</div>';
        }

        async function testApiHealth() {
            const result = document.getElementById('loginResult');
            result.innerHTML = '<div class="status">üîÑ Testing API health...</div>';

            try {
                const response = await fetch('https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/Businesses', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const statusClass = response.ok ? 'success' : 'error';
                const statusIcon = response.ok ? '‚úÖ' : '‚ùå';

                result.innerHTML += `
                    <div class="status ${statusClass}">
                        ${statusIcon} API Health Check
                    </div>
                    <pre>Status: ${response.status} ${response.statusText}
URL: GET /api/Businesses
Response: ${response.ok ? 'API is accessible' : 'API has issues'}</pre>
                `;

                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML += `<pre>Sample Response: ${JSON.stringify(data, null, 2).substring(0, 300)}...</pre>`;
                }

            } catch (error) {
                result.innerHTML += `
                    <div class="status error">‚ùå API Health Check Failed</div>
                    <pre>Network Error: ${error.message}</pre>
                `;
            }
        }

        async function testStaffLogin() {
            const result = document.getElementById('loginResult');
            result.innerHTML += '<div class="status">üîÑ Testing staff login (Marco)...</div>';

            const credentials = {
                email: 'marco@hotelcoral.al',
                password: '111111'
            };

            await performLogin(credentials, 'Staff Login (Marco)', false);
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const credentials = { email, password };
            await performLogin(credentials, 'SuperAdmin Login', true);
        }

        async function performLogin(credentials, testName, showDetails = true) {
            const result = document.getElementById('loginResult');
            const details = document.getElementById('requestDetails');
            
            result.innerHTML += `<div class="status">üîÑ Testing ${testName}...</div>`;

            if (showDetails) {
                // Show request details
                details.innerHTML = `
                    <h4>Request Details:</h4>
                    <pre>URL: POST https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/Auth/login
Headers: Content-Type: application/json
Body: ${JSON.stringify(credentials, null, 2)}</pre>
                `;
            }

            try {
                const response = await fetch('https://blackbear-api.kindhill-9a9eea44.italynorth.azurecontainerapps.io/api/Auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = { rawResponse: responseText };
                }

                const statusClass = response.ok ? 'success' : 'error';
                const statusIcon = response.ok ? '‚úÖ' : '‚ùå';

                if (response.ok) {
                    result.innerHTML += `
                        <div class="status ${statusClass}">${statusIcon} ${testName} Successful!</div>
                        <pre>Status: ${response.status}
User ID: ${data.userId || 'N/A'}
Email: ${data.email || 'N/A'}
Full Name: ${data.fullName || 'N/A'}
User Type: ${data.userType || 'N/A'}
Token: ${data.token ? 'Present (' + data.token.substring(0, 20) + '...)' : 'Missing'}
Expiration: ${data.expiration || 'N/A'}</pre>
                    `;

                    // Special check for SuperAdmin
                    if (testName.includes('SuperAdmin')) {
                        if (data.userType === 'SuperAdmin') {
                            result.innerHTML += '<div class="status success">üéâ SuperAdmin role confirmed!</div>';
                        } else {
                            result.innerHTML += `<div class="status warning">‚ö†Ô∏è Role issue: Expected SuperAdmin, got ${data.userType}</div>`;
                        }
                    }
                } else {
                    result.innerHTML += `
                        <div class="status ${statusClass}">${statusIcon} ${testName} Failed</div>
                        <pre>Status: ${response.status} ${response.statusText}
Error: ${data.message || data.title || 'Unknown error'}
Response: ${JSON.stringify(data, null, 2)}
Raw Response: ${responseText}</pre>
                    `;

                    // Specific error analysis
                    if (response.status === 401) {
                        result.innerHTML += '<div class="status error">üîç 401 Analysis: Invalid credentials or user not found</div>';
                    } else if (response.status === 403) {
                        result.innerHTML += '<div class="status error">üîç 403 Analysis: User exists but access forbidden</div>';
                    } else if (response.status === 400) {
                        result.innerHTML += '<div class="status error">üîç 400 Analysis: Bad request format or validation error</div>';
                    }
                }

                if (showDetails) {
                    // Show response headers
                    details.innerHTML += `
                        <h4>Response Headers:</h4>
                        <pre>${Array.from(response.headers.entries()).map(([key, value]) => `${key}: ${value}`).join('\n')}</pre>
                    `;
                }

            } catch (error) {
                result.innerHTML += `
                    <div class="status error">‚ùå ${testName} - Network Error</div>
                    <pre>Error: ${error.message}
Type: ${error.name}
Stack: ${error.stack ? error.stack.substring(0, 200) + '...' : 'N/A'}</pre>
                `;
            }
        }
    </script>
</body>
</html>